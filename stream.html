<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="mobile-web-app-capable" content="yes">
    <title>mapMD</title>
</head>
<script src="pixi.js"></script>
<script src="js/tools/webcam.js"></script>
<script src="js/tools/tools.js"></script>
<script src="js/tools/ColorMapFilter.js"></script>
<script src="js/tools/webcam.js"></script>
<body>
<style>* {
    padding: 0;
    margin: 0;
    height: 100%;

}
</style>
<script type="text/javascript">
    class BarrelFilter extends PIXI.Filter {
        constructor(power = 1.2, offset = { x: 0, y: 0 }) {
            super(undefined, BarrelFilter.fragment);
            this.uniforms.dimensions = { x: 0, y: 0 };
            this.uniforms.filterArea = { x: 0, y: 0, z: 0, w: 0 };
            this.uniforms.power = power;
            this.uniforms.offset = offset;
        }
        apply(filterManager, input, output) {
            this.uniforms.dimensions.x = input.sourceFrame.width;
            this.uniforms.dimensions.y = input.sourceFrame.height;
            this.uniforms.filterArea.x = output.size.width;
            this.uniforms.filterArea.y = output.size.height;
            this.uniforms.filterArea.z = input.sourceFrame.x;
            this.uniforms.filterArea.w = input.sourceFrame.y;
            filterManager.applyFilter(this, input, output);
        }
    }
    BarrelFilter.fragment = `
        precision highp float;

        varying vec2 vTextureCoord;
        uniform sampler2D uSampler;
        uniform vec2 dimensions;
        uniform vec4 filterArea;

        uniform float power;
        uniform vec2 offset;

        vec2 mapCoord( vec2 coord ){
            coord *= filterArea.xy;
            coord += filterArea.zw;
            return coord;
        }

        vec2 unmapCoord( vec2 coord ){
            coord -= filterArea.zw;
            coord /= filterArea.xy;
            return coord;
        }

        // Given a vec2 in [-1,+1], generate a texture coord in [0,+1]
        vec2 barrelDistortion(vec2 p)
        {
            float theta  = atan(p.y, p.x);
            float radius = length(p);
            radius = pow(radius, power);
            p.x = radius * cos(theta);
            p.y = radius * sin(theta);
            return 0.5 * (p + 1.0);
        }

        void main(){
            vec2 uv = mapCoord(vTextureCoord) / dimensions;
            uv = barrelDistortion(uv*2.0 - 1.0 + offset);
            gl_FragColor = vec4(texture2D(uSampler, unmapCoord(uv*dimensions)).rgb, 1.0);
        }
    `;

    //Create the renderer
    var stage = new PIXI.Container(),
        renderer = PIXI.autoDetectRenderer(0, 0);
    document.body.appendChild(renderer.view);

    renderer.view.style.position = "absolute";
    renderer.view.style.display = "block";
    renderer.autoResize = true;
    renderer.resize(window.innerWidth, window.innerHeight);

    //Use Pixi's built-in `loader` object to load an image
//    PIXI.loader
//            .add("img_fjords.jpg")
//            .load(setup);

    //This `setup` function will run when the image has loaded

    const webcam = new Webcam();
    webcam.onReady.add(onWebcam);
    webcam.init();

    function setup() {

//        //Create the `cat` sprite from the texture
//        var cat = new PIXI.Sprite(
//            PIXI.loader.resources["img_fjords.jpg"].texture
//        );
//
//        //Add the cat to the stage
//        stage.addChild(cat);

        //Render the stage
        renderer.render(stage);
    }

    let texture;
    let sprite;

    function onWebcam() {
        console.log('webcam loaded');
        console.log(webcam.video);
        texture = new PIXI.Texture.fromVideo(webcam.video);
        sprite = new PIXI.Sprite(texture);

        sprite.x = 0;
        sprite.y = 0;
        sprite.height = renderer.height;
        sprite.width = renderer.width/2;
        sprite.filters = [new BarrelFilter(1.2)];

        stage.addChild(sprite);

        sprite = new PIXI.Sprite(texture);

        sprite.x = renderer.width/2;
        sprite.y = 0;
        sprite.height = renderer.height;
        sprite.width = renderer.width/2;
        sprite.filters = [new BarrelFilter(1.2)];

        stage.addChild(sprite);


        renderer.render(stage);

        loop();

//        requestAnimationFrame(loop);

    }

    function loop() {
        setTimeout(loop, 70);

        sprite.texture.update();
        console.log('loop');
        renderer.render(stage);
    }

    setup();
</script>
</body>
</html>